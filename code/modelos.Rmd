---
title: "Modelos"
output:
  pdf_document: default
  html_notebook: default
---

```{r}
library(readr)
library(R2jags)
library(ggplot2)
library(dplyr)
library(readr)
library(tidyr)

#--- Usar espejo CRAN del ITAM ---
options(repos="http://cran.itam.mx/")

#--- Funciones utiles ---
prob<-function(x){
  out<-min(length(x[x>0])/length(x),length(x[x<0])/length(x))
  out
}

```


## Analisis Exploratorio

En primer lugar, vamos a entender la base de datos Gestacional

```{r}
read_csv("./../data/clean_rotacion.csv")
```


```{r}
datos <- read_csv("./../data/clean_rotacion.csv", col_types = list(col_double(),
     col_character(), col_double(),col_double(),col_character(),col_double(),
     col_double(),col_double(), col_double(),col_double(),col_double(),col_double(),
     col_double(),col_double(),col_double(),col_double(),col_double(),col_double()))


```


## Preprocesamiento


```{r}
colnames(datos)
datos$antiguedad <- datos$antigüedad
```


## Modelos

Las varibles continuas se centraran en cero
```{r}
library(lubridate)

n<-dim(datos)[1]
y<- datos$rotacion

data$rotacion <- case_when(data$rotacion==0 ~1, 
                           TRUE~0)
#Variables explicativas
#Categoricas
datos$experiencia[is.na(datos$experiencia)] <- 0
datos$experiencia <- datos$experiencia +1
experiencia <- datos$experiencia

datos$genero <- factor(datos$genero)
datos$genero <- droplevels(datos$genero)
datos$genero <- as.integer(datos$genero)
genero <- datos$genero

datos$dependientes[is.na(datos$dependientes)] <- 0
datos$dependientes <- datos$dependientes +1
dependientes <- datos$dependientes

datos$div[is.na(datos$div)] <- 0
datos$div <- datos$div +1
div <- datos$div #region

datos$edo_civil[is.na(datos$edo_civil)] <- 0
datos$edo_civil <- datos$edo_civil +1
edo_civil <- datos$edo_civil

datos$escolaridad[is.na(datos$escolaridad)] <- 0
datos$escolaridad<- datos$escolaridad +1
escolaridad <- datos$escolaridad

datos$mes <- as.numeric(format(as.Date(datos$f_alta,format = "%d-%b-%y"), "%m"))
mes <- datos$mes

#Continuas
datos$edad<- as.vector(scale(datos$edad))
datos$edad[is.na(datos$edad)] <- median(datos$edad)
edad <- datos$edad

datos$num_ventas <- as.vector(scale(datos$num_ventas))
datos$num_ventas[is.na(datos$num_ventas)] <- 0
num_ventas <- datos$num_ventas

datos$num_trabajos_previos <- as.vector(scale(datos$num_trabajos_previos))
datos$num_trabajos_previos[is.na(datos$num_trabajos_previos)] <- 0
num_trabajos_previos <- datos$num_trabajos_previos


datos$sueldo_prom <- as.vector(scale(datos$sueldo_prom)) 
datos$sueldo_prom[is.na(datos$sueldo_prom)] <- 0
sueldo_prom <- datos$sueldo_prom

datos$salario_diario_ant <-  as.vector(scale(datos$salario_diario_ant)) 
datos$salario_diario_ant[is.na(datos$salario_diario_ant)] <- 0
salario_diario_ant <- datos$salario_diario_ant

datos$antiguedad<-  as.vector(scale(datos$antiguedad))
datos$antiguedad[is.na(datos$antiguedad)] <- 0
antiguedad <- datos$antiguedad

datos$incremento<-  as.vector(scale(datos$incremento))
datos$incremento[is.na(datos$incremento)] <- 0
incremento <- datos$incremento

datos <- datos %>% mutate(
  grupo_edad=0,
  grupo_edad = case_when(
    edad < 28 ~  1,
    edad > 47 ~ 3,
    TRUE ~ 2
  )
)

datos <- datos %>% mutate(
  grupo_sueldo=0,
  grupo_sueldo = case_when(
    sueldo_prom < 2000 ~  1,
    sueldo_prom  > 10000 ~ 3,
    TRUE ~ 2
  )
)

write.csv(datos, "./../data/datos.csv")


```

```{r}

# ORDEN: Categoricas, numericas y después dev
#-Definiendo datos-
data<-list("n"=n,"y"=y,"experiencia"= experiencia,
           "genero"=genero,"dependientes"=dependientes,
           "edo_civil"=edo_civil,"escolaridad"=escolaridad,
           "mes"=mes,
           "num_ventas"=num_ventas,
            "edad"=edad,"num_trabajos"=num_trabajos_previos,
            "sueldo_prom"=sueldo_prom, "sueldo_ant" =salario_diario_ant,
           "antiguedad" =antiguedad, "incremento"=incremento,
           "div"=div)

#-Definiendo inits-
inits<-function(){list(alpha=0,
                       b_exp=rep(0,3),b_gen=rep(0,2),
                       b_dep = rep(0,4), b_edo_c = rep(0,3),
                       b_esc = rep(0,4), b_mes = rep(0,12), 
                       b_num_v = 0, b_edad = 0, b_num_t =0,
                       b_suel = 0, b_suel_ant = 0, b_ant = 0, 
                       b_inc = 0, b_div = rep(0,3))}

#-Seleccionando parametros a monitorear-
parameters_complete<-c("alpha.est", 
              "b_exp.est", "b_gen.est", "b_dep.est", "b_edo_c.est", "b_esc.est",
              "b_mes.est", "b_num_v", "b_edad", "b_num_t","b_suel",
              "b_suel_ant", "b_ant", "b_inc", "b_div.est")


```

Corremos regresion frequentista
```{r}
 mle <- glm(y~edad+num_ventas+antiguedad+sueldo_prom+num_trabajos_previos+genero ,family="binomial")
  summary(mle)
```

```{r}
#-Corrida de codigo-
#JAGS
mod1.sim<-jags(data,inits,parameters_complete,model.file="./../models/logit.txt",
              n.iter=100,n.chains=2,n.burnin=10,n.thin=1)
out.dic<-mod1.sim$BUGSoutput$DIC
print(out.dic)

mod1.sim<-jags(data,inits,parameters_complete,model.file="./../models/probit.txt",
              n.iter=5000,n.chains=2,n.burnin=1000,n.thin=1)
out.dic<-mod1.sim$BUGSoutput$DIC
print(out.dic)

mod1.sim<-jags(data,inits,parameters_complete,model.file="./../models/cloglog.txt",
              n.iter=5000,n.chains=2,n.burnin=1000,n.thin=1)
out.dic<-mod1.sim$BUGSoutput$DIC
print(out.dic)
```


```{r}
#JAGS
out<-mod1.sim$BUGSoutput$sims.list
out.dic<-mod1.sim$BUGSoutput$DIC
print(out.dic)

```



```{r}
#JAGS
out.sum<-mod1.sim$BUGSoutput$summary

#ALPHA
z<-out$alpha.est
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Alfa")

z<-out$b_num_v 
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Número ventas")

z<-out$b_num_v 
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Número ventas")


z<-out$b_edad 
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Edad")


z<-out$b_num_t 
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Número trabajos anteriores")



z<-out$b_suel
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Sueldo")


z<-out$b_suel_ant
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Sueldo anterior")

z<-out$b_ant
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Antiguedad")

z<-out$b_inc
par(mfrow=c(2,2))
plot(z,type="l")
plot(cumsum(z)/(1:length(z)),type="l")
hist(z,freq=FALSE)
acf(z)
title("Efecto: Incremento")


out.est<-out.sum[grep("b_exp",rownames(out.sum)),]
k<-3
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="categoria",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Experiencia")

out.est<-out.sum[grep("b_gen",rownames(out.sum)),]
k<-2
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="categoria",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Genero")


out.est<-out.sum[grep("b_dep",rownames(out.sum)),]
k<-4
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="categoria",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Dependientes")


out.est<-out.sum[grep("b_edo_c",rownames(out.sum)),]
k<-3
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="categoria",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Estado Civil")

out.est<-out.sum[grep("b_esc",rownames(out.sum)),]
k<-4
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="categoria",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Escolaridad")

out.est<-out.sum[grep("b_mes",rownames(out.sum)),]
k<-12
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="categoria",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Mes")


out.est<-out.sum[grep("b_div",rownames(out.sum)),]
k<-3
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="categoria",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Region")

```


## Interacciones

Antes de crear las interacciones podemos graficar nuestra hipotesis.

```{r}
res<-cor(datos)
round(res, 2)

library(corrplot)
corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

```


```{r}
ggplot(datos, aes(x=factor(genero), fill=factor(escolaridad))) +
  geom_bar(position="stack")+ 
  facet_grid(~rotacion)
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"),
          axis.title = element_text(size=15), axis.text =  element_text(size=9), 
          axis.text.x = element_text(angle=0))
```




```{r}
#-Definiendo datos-
data<-list("n"=n,"y"=y,"experiencia"= experiencia,
           "genero"=genero,"dependientes"=dependientes,
           "edo_civil"=edo_civil,"escolaridad"=escolaridad,
           "mes"=mes, "num_ventas"=num_ventas,
            "edad"=edad,"num_trabajos"=num_trabajos_previos,
            "sueldo_prom"=sueldo_prom, "sueldo_ant" =salario_diario_ant,
           "antiguedad" =antiguedad, "incremento"=incremento,
           "div"=div)

#-Definiendo inits-
inits_sin_miss<-function(){list(alpha=0,
                       b_exp=rep(0,3),b_gen=rep(0,2),
                       b_dep = rep(0,4), b_edo_c = rep(0,3),
                       b_esc = rep(0,4), b_mes = rep(0,12), 
                       b_num_v = 0, b_edad = 0, b_num_t =0,
                       b_suel = 0, b_suel_ant = 0, b_ant = 0, 
                       b_inc = 0, b_div = rep(0,3))}

inits<-function(){list(alpha=0,
                       b_exp=rep(0,3),b_gen=rep(0,2),
                       b_dep = rep(0,4), b_edo_c = rep(0,3),
                       b_esc = rep(0,4), b_mes = rep(0,12), 
                       b_num_v = 0, b_edad = 0, b_num_t =0,
                       b_suel = 0, b_suel_ant = 0, b_ant = 0, 
                       b_inc = 0, b_div = rep(0,3))}

#-Seleccionando parametros a monitorear-
parameters_complete<-c("alpha.est", 
              "b_exp.est", "b_gen.est", "b_dep.est", "b_edo_c.est", "b_esc.est",
              "b_mes.est", "b_num_v", "b_edad", "b_num_t","b_suel",
              "b_suel_ant", "b_ant", "b_inc", "b_div.est")


mod1.sim<-jags(data,inits,parameters_complete,model.file="Ex_cloglog_int.txt",
              n.iter=1000,n.chains=2,n.burnin=100,n.thin=1)
out.dic<-mod1.sim$BUGSoutput$DIC
print(out.dic)

```

Comprobamos que la interacción estuvo bien implementada

```{r}
out.sum<-mod1.sim$BUGSoutput$summary


out.b_an<-out.sum[grep("b_an.est",rownames(out.sum)),]
out.est<-out.b_an
k<-2
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="dia",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Anestesia")

out.b_fn<-out.sum[grep("b_fn.est",rownames(out.sum)),]
out.est<-out.b_fn
k<-2
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="dia",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Forma Nacimiento")


out.b_an_fn<-out.sum[grep("b_an_fn.est",rownames(out.sum)),]
out.est<-out.b_an_fn[c(3,4),]
k<-2
ymin<-min(out.est[,c(1,3,7)])
ymax<-max(out.est[,c(1,3,7)])
plot(1:k,out.est[,1],xlab="",ylab="",ylim=c(ymin,ymax))
segments(1:k,out.est[,3],1:k,out.est[,7])
abline(h=0,col="grey70")
title("Efecto: Forma Nacimiento Vaginal con y sin anestesia")

```

La probabilidad de sobrevivir parece más alta pero sigue sin ser significativa. Parece que mete ruido en los datos en vez de dar información.

```{r}

```


